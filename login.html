<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login with OTP Verification</title>
    <link rel="shortcut icon" href="assets/images/kralogol.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .container {
        max-width: 400px;
        margin-top: 100px;
      }
      #otpSection {
        transition: all 0.3s ease;
      }
      .error-message {
        color: #dc3545;
        margin-top: 5px;
      }
      .resend-otp {
        margin-top: 10px;
        font-size: 0.9rem;
      }
      body {
        background-image: url("assets/images/bg-f1.png"); /* Adjust path if needed */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 5px 5px 15px rgba(235, 7, 7, 0.1);
      }

      .container {
        background-color: rgba(241, 241, 241, 0.95); /* soft white with slight transparency */
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 400px;
        width: 100%;
      }
      body::before {
        content: "";
        position: absolute;
        inset: 0;
        background: inherit;
        filter: blur(1px);
        z-index: -1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">Login</h3>

          <!-- Error Message Container -->
          <div id="errorMessage" class="alert alert-danger d-none"></div>

          <!-- Login Form -->
          <form id="loginForm">
            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="email"
                required
                placeholder="Enter your email"
              />
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                class="form-control"
                id="password"
                required
                placeholder="Enter your password"
              />
            </div>
            <button type="submit" class="btn btn-primary w-100" id="loginBtn">
              <span id="loginText">Login</span>
              <span
                id="loginSpinner"
                class="spinner-border spinner-border-sm d-none"
                role="status"
              ></span>
            </button>
          </form>

          <!-- OTP Verification Section -->
          <div id="otpSection" class="mt-3" style="display: none">
            <p class="text-center">
              We've sent an OTP to your registered email
            </p>
            <div class="mb-3">
              <label for="otp" class="form-label">Enter OTP</label>
              <input
                type="text"
                class="form-control"
                id="otp"
                placeholder="6-digit code"
                maxlength="6"
              />
              <div id="otpError" class="error-message"></div>
            </div>
            <button id="verifyLoginOtp" class="btn btn-primary w-100 mb-2">
              <span id="verifyText">Verify</span>
              <span
                id="verifySpinner"
                class="spinner-border spinner-border-sm d-none"
                role="status"
              ></span>
            </button>
            <div class="text-center resend-otp">
              <a href="#" id="resendOtpLink">Resend OTP</a>
              <span id="countdown" class="text-muted ms-2"></span>
            </div>
          </div>

          <div class="text-center mt-3">
            <a href="register.html">Don't have an account? Register</a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const loginForm = document.getElementById("loginForm");
        const otpSection = document.getElementById("otpSection");
        const errorMessage = document.getElementById("errorMessage");
        const otpError = document.getElementById("otpError");
        const loginBtn = document.getElementById("loginBtn");
        const loginText = document.getElementById("loginText");
        const loginSpinner = document.getElementById("loginSpinner");
        const verifyBtn = document.getElementById("verifyLoginOtp");
        const verifyText = document.getElementById("verifyText");
        const verifySpinner = document.getElementById("verifySpinner");
        const resendOtpLink = document.getElementById("resendOtpLink");
        const countdown = document.getElementById("countdown");

        let otpResendTimer;
        let otpResendTime = 60; // 60 seconds cooldown

        // Handle login form submission
        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const email = document.getElementById("email").value.trim();
          const password = document.getElementById("password").value;

          // Validate inputs
          if (!email || !password) {
            showError("Please fill in all fields");
            return;
          }

          // Show loading state
          loginText.classList.add("d-none");
          loginSpinner.classList.remove("d-none");
          loginBtn.disabled = true;

          try {
            const response = await fetch("api/login.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email, password }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Login failed");
            }

            if (data.success) {
              // Hide login form, show OTP section
              loginForm.style.display = "none";
              otpSection.style.display = "block";
              localStorage.setItem("tempUserId", data.userId);
              localStorage.setItem("tempUserEmail", email);

              // Start OTP resend countdown
              startOtpResendCountdown();
            } else {
              throw new Error(data.message || "Login failed");
            }
          } catch (error) {
            showError(error.message);
          } finally {
            // Reset loading state
            loginText.classList.remove("d-none");
            loginSpinner.classList.add("d-none");
            loginBtn.disabled = false;
          }
        });

        // Handle OTP verification
        verifyBtn.addEventListener("click", async () => {
          const otp = document.getElementById("otp").value.trim();
          const userId = localStorage.getItem("tempUserId");

          if (!otp || otp.length !== 6) {
            otpError.textContent = "Please enter a valid 6-digit OTP";
            return;
          }

          // Show loading state
          verifyText.classList.add("d-none");
          verifySpinner.classList.remove("d-none");
          verifyBtn.disabled = true;

          try {
            const response = await fetch("api/verify-login-otp.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, otp }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Verification failed");
            }

            if (data.success) {
              // Store token and redirect
              localStorage.setItem("authToken", data.token);

              // Clear temp storage
              localStorage.removeItem("tempUserId");
              localStorage.removeItem("tempUserEmail");

              // Redirect to dashboard or intended page
              const redirectUrl =
                new URLSearchParams(window.location.search).get("redirect") ||
                "dashboard.php";
              window.location.href = redirectUrl;
            } else {
              throw new Error(data.message || "Invalid OTP");
            }
          } catch (error) {
            otpError.textContent = error.message;
          } finally {
            // Reset loading state
            verifyText.classList.remove("d-none");
            verifySpinner.classList.add("d-none");
            verifyBtn.disabled = false;
          }
        });

        // Handle OTP resend
        resendOtpLink.addEventListener("click", async (e) => {
          e.preventDefault();

          if (otpResendTimer) return; // Prevent multiple clicks during cooldown

          const userId = localStorage.getItem("tempUserId");
          const email = localStorage.getItem("tempUserEmail");

          try {
            const response = await fetch("api/resend-otp.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, email }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Failed to resend OTP");
            }

            if (data.success) {
              // Restart countdown
              startOtpResendCountdown();
              otpError.textContent = "";
              showError("New OTP sent successfully", "success");
            }
          } catch (error) {
            showError(error.message);
          }
        });

        // Helper function to show error messages
        function showError(message, type = "error") {
          errorMessage.textContent = message;
          errorMessage.classList.remove(
            "d-none",
            "alert-success",
            "alert-danger"
          );
          errorMessage.classList.add(
            type === "error" ? "alert-danger" : "alert-success"
          );

          // Auto-hide after 5 seconds
          setTimeout(() => {
            errorMessage.classList.add("d-none");
          }, 5000);
        }

        // OTP resend countdown timer
        function startOtpResendCountdown() {
          clearInterval(otpResendTimer);
          otpResendTime = 60;
          updateCountdownDisplay();

          otpResendTimer = setInterval(() => {
            otpResendTime--;
            updateCountdownDisplay();

            if (otpResendTime <= 0) {
              clearInterval(otpResendTimer);
              otpResendTimer = null;
            }
          }, 1000);
        }

        function updateCountdownDisplay() {
          if (otpResendTime > 0) {
            resendOtpLink.style.pointerEvents = "none";
            resendOtpLink.style.color = "#6c757d";
            countdown.textContent = `(in ${otpResendTime}s)`;
          } else {
            resendOtpLink.style.pointerEvents = "auto";
            resendOtpLink.style.color = "";
            countdown.textContent = "";
          }
        }
      });
    </script>
  </body>
</html>
