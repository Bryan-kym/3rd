<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register Account</title>
    <link rel="shortcut icon" href="assets/images/kralogol.png" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/css/intlTelInput.css"
    />
    <style>
      .container {
        max-width: 600px;
        margin-top: 50px;
      }
      #otpSection {
        transition: all 0.3s ease;
      }
      .error-message {
        color: #dc3545;
        margin-top: 5px;
      }
      .password-strength {
        height: 5px;
        margin-top: 5px;
        background: #e9ecef;
        border-radius: 3px;
        overflow: hidden;
      }
      .password-strength-bar {
        height: 100%;
        width: 0;
        transition: width 0.3s ease;
      }
      .password-match {
        color: #28a745;
      }
      .password-mismatch {
        color: #dc3545;
      }
      body {
        background-image: url("assets/images/bg-f.png");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 5px 5px 15px rgba(235, 7, 7, 0.1);
      }
      .container {
        background-color: rgba(241, 241, 241, 0.95);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        max-width: 600px;
        width: 100%;
      }
      .form-section {
        margin-bottom: 1.5rem;
      }
      .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
      }
      .intl-tel-input {
        width: 100%;
      }
      .iti {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <div class="card-body">
          <h3 class="card-title text-center mb-4">Create Account</h3>

          <!-- Error Message Container -->
          <div id="errorMessage" class="alert alert-danger d-none"></div>

          <!-- Registration Form -->
          <form id="registerForm">
            <div class="form-section">
              <div class="section-title">Personal Information</div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="surname" class="form-label">Surname *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="surname"
                    required
                    placeholder="Enter your surname"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label for="otherNames" class="form-label">Other Names *</label>
                  <input
                    type="text"
                    class="form-control"
                    id="otherNames"
                    required
                    placeholder="Enter your other names"
                  />
                </div>
              </div>
              
              <div class="mb-3">
                <label for="email" class="form-label">Email *</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  required
                  placeholder="Enter your email"
                />
              </div>
              
              <div class="mb-3">
                <label for="phone" class="form-label">Phone Number *</label>
                <input
                  type="tel"
                  class="form-control"
                  id="phone"
                  required
                  placeholder="Enter your phone number"
                />
                <input type="hidden" id="fullPhone" name="fullPhone">
                <small class="text-muted">Include country code (e.g. +254...)</small>
              </div>
            </div>

            <div class="form-section">
              <div class="section-title">Account Security</div>
              <div class="mb-3">
                <label for="password" class="form-label">Password *</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  required
                  placeholder="Create a password"
                />
                <div class="password-strength mt-2">
                  <div
                    class="password-strength-bar"
                    id="passwordStrengthBar"
                  ></div>
                </div>
                <small class="text-muted"
                  >Minimum 8 characters with at least 1 number and 1 special
                  character</small
                >
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label"
                  >Confirm Password *</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="confirmPassword"
                  required
                  placeholder="Re-enter your password"
                />
                <small id="passwordMatchMessage" class="d-none"></small>
              </div>
            </div>

            <button
              type="submit"
              class="btn btn-primary w-100"
              id="registerBtn"
            >
              <span id="registerText">Register</span>
              <span
                id="registerSpinner"
                class="spinner-border spinner-border-sm d-none"
                role="status"
              ></span>
            </button>
          </form>

          <!-- OTP Verification Section -->
          <div id="otpSection" class="mt-3" style="display: none">
            <p class="text-center">
              We've sent a verification code to your email
            </p>
            <div class="mb-3">
              <label for="otp" class="form-label">Enter OTP</label>
              <input
                type="text"
                class="form-control"
                id="otp"
                placeholder="6-digit code"
                maxlength="6"
              />
              <div id="otpError" class="error-message"></div>
            </div>
            <button id="verifyOtp" class="btn btn-primary w-100 mb-2">
              <span id="verifyText">Verify Account</span>
              <span
                id="verifySpinner"
                class="spinner-border spinner-border-sm d-none"
                role="status"
              ></span>
            </button>
            <div class="text-center">
              <a href="#" id="resendOtpLink">Resend OTP</a>
              <span id="countdown" class="text-muted ms-2"></span>
            </div>
          </div>

          <div class="text-center mt-3">
            <a href="login.html">Already have an account? Login</a>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/intlTelInput.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const registerForm = document.getElementById("registerForm");
        const otpSection = document.getElementById("otpSection");
        const errorMessage = document.getElementById("errorMessage");
        const otpError = document.getElementById("otpError");
        const registerBtn = document.getElementById("registerBtn");
        const registerText = document.getElementById("registerText");
        const registerSpinner = document.getElementById("registerSpinner");
        const verifyBtn = document.getElementById("verifyOtp");
        const verifyText = document.getElementById("verifyText");
        const verifySpinner = document.getElementById("verifySpinner");
        const resendOtpLink = document.getElementById("resendOtpLink");
        const countdown = document.getElementById("countdown");
        const passwordInput = document.getElementById("password");
        const confirmPasswordInput = document.getElementById("confirmPassword");
        const passwordMatchMessage = document.getElementById(
          "passwordMatchMessage"
        );
        const passwordStrengthBar = document.getElementById(
          "passwordStrengthBar"
        );

        // Initialize international telephone input
        const phoneInput = document.querySelector("#phone");
        const iti = window.intlTelInput(phoneInput, {
          utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@18.1.1/build/js/utils.js",
          preferredCountries: ['ke', 'ug', 'tz', 'za'],
          separateDialCode: true,
          initialCountry: "auto",
          geoIpLookup: function(callback) {
            fetch("https://ipapi.co/json")
              .then(function(res) { return res.json(); })
              .then(function(data) { callback(data.country_code); })
              .catch(function() { callback('ke'); });
          }
        });

        // Update hidden full phone number field
        phoneInput.addEventListener('blur', function() {
          const fullPhone = iti.getNumber();
          document.getElementById('fullPhone').value = fullPhone;
        });

        let otpResendTimer;
        let otpResendTime = 60; // 60 seconds cooldown

        // Password strength indicator
        passwordInput.addEventListener("input", function () {
          const strength = calculatePasswordStrength(this.value);
          updatePasswordStrengthIndicator(strength);
          checkPasswordMatch();
        });

        // Password confirmation check
        confirmPasswordInput.addEventListener("input", checkPasswordMatch);

        function checkPasswordMatch() {
          const password = passwordInput.value;
          const confirmPassword = confirmPasswordInput.value;

          if (password && confirmPassword) {
            if (password === confirmPassword) {
              passwordMatchMessage.textContent = "Passwords match";
              passwordMatchMessage.classList.remove(
                "d-none",
                "password-mismatch"
              );
              passwordMatchMessage.classList.add("password-match");
            } else {
              passwordMatchMessage.textContent = "Passwords do not match";
              passwordMatchMessage.classList.remove("d-none", "password-match");
              passwordMatchMessage.classList.add("password-mismatch");
            }
          } else {
            passwordMatchMessage.classList.add("d-none");
          }
        }

        // Handle registration form submission
        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const surname = document.getElementById("surname").value.trim();
          const otherNames = document.getElementById("otherNames").value.trim();
          const email = document.getElementById("email").value.trim();
          const phone = document.getElementById("fullPhone").value;
          const password = document.getElementById("password").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;

          // Validate inputs
          if (!surname || !otherNames || !email || !phone || !password || !confirmPassword) {
            showError("Please fill in all required fields");
            return;
          }

          if (!validateName(surname) || !validateName(otherNames)) {
            showError("Names should only contain letters and spaces");
            return;
          }

          if (!validateEmail(email)) {
            showError("Please enter a valid email address");
            return;
          }

          if (!iti.isValidNumber()) {
            showError("Please enter a valid phone number");
            return;
          }

          if (!validatePassword(password)) {
            showError(
              "Password must be at least 8 characters with 1 number and 1 special character"
            );
            return;
          }

          if (password !== confirmPassword) {
            showError("Passwords do not match");
            return;
          }

          // Show loading state
          registerText.classList.add("d-none");
          registerSpinner.classList.remove("d-none");
          registerBtn.disabled = true;

          try {
            const response = await fetch("api/register.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ 
                surname, 
                otherNames, 
                email, 
                phone, 
                password 
              }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Registration failed");
            }

            if (data.success) {
              // Hide registration form, show OTP section
              registerForm.style.display = "none";
              otpSection.style.display = "block";
              localStorage.setItem("tempUserId", data.userId);
              localStorage.setItem("tempUserEmail", email);

              // Start OTP resend countdown
              startOtpResendCountdown();
            } else {
              throw new Error(data.message || "Registration failed");
            }
          } catch (error) {
            showError(error.message);
          } finally {
            // Reset loading state
            registerText.classList.remove("d-none");
            registerSpinner.classList.add("d-none");
            registerBtn.disabled = false;
          }
        });

        // Handle OTP verification
        verifyBtn.addEventListener("click", async () => {
          const otp = document.getElementById("otp").value.trim();
          const userId = localStorage.getItem("tempUserId");

          if (!otp || otp.length !== 6) {
            otpError.textContent = "Please enter a valid 6-digit OTP";
            return;
          }

          // Show loading state
          verifyText.classList.add("d-none");
          verifySpinner.classList.remove("d-none");
          verifyBtn.disabled = true;

          try {
            const response = await fetch("api/verify-registration-otp.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, otp }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Verification failed");
            }

            if (data.success) {
              // Store token and redirect
              localStorage.setItem("authToken", data.token);

              // Clear temp storage
              localStorage.removeItem("tempUserId");
              localStorage.removeItem("tempUserEmail");

              // Redirect to dashboard or intended page
              window.location.href = "dashboard.php";
            } else {
              throw new Error(data.message || "Invalid OTP");
            }
          } catch (error) {
            otpError.textContent = error.message;
          } finally {
            // Reset loading state
            verifyText.classList.remove("d-none");
            verifySpinner.classList.add("d-none");
            verifyBtn.disabled = false;
          }
        });

        // Handle OTP resend
        resendOtpLink.addEventListener("click", async (e) => {
          e.preventDefault();

          if (otpResendTimer) return; // Prevent multiple clicks during cooldown

          const userId = localStorage.getItem("tempUserId");
          const email = localStorage.getItem("tempUserEmail");

          try {
            const response = await fetch("api/resend-registration-otp.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ userId, email }),
            });

            const data = await response.json();

            if (!response.ok) {
              throw new Error(data.message || "Failed to resend OTP");
            }

            if (data.success) {
              // Restart countdown
              startOtpResendCountdown();
              otpError.textContent = "";
              showError("New OTP sent successfully", "success");
            }
          } catch (error) {
            showError(error.message);
          }
        });

        // Helper functions
        function showError(message, type = "error") {
          errorMessage.textContent = message;
          errorMessage.classList.remove(
            "d-none",
            "alert-success",
            "alert-danger"
          );
          errorMessage.classList.add(
            type === "error" ? "alert-danger" : "alert-success"
          );

          setTimeout(() => {
            errorMessage.classList.add("d-none");
          }, 5000);
        }

        function startOtpResendCountdown() {
          clearInterval(otpResendTimer);
          otpResendTime = 60;
          updateCountdownDisplay();

          otpResendTimer = setInterval(() => {
            otpResendTime--;
            updateCountdownDisplay();

            if (otpResendTime <= 0) {
              clearInterval(otpResendTimer);
              otpResendTimer = null;
            }
          }, 1000);
        }

        function updateCountdownDisplay() {
          if (otpResendTime > 0) {
            resendOtpLink.style.pointerEvents = "none";
            resendOtpLink.style.color = "#6c757d";
            countdown.textContent = `(in ${otpResendTime}s)`;
          } else {
            resendOtpLink.style.pointerEvents = "auto";
            resendOtpLink.style.color = "";
            countdown.textContent = "";
          }
        }

        function validateEmail(email) {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(email);
        }

        function validateName(name) {
          const re = /^[a-zA-Z\s\-']+$/;
          return re.test(name);
        }

        function validatePassword(password) {
          // Minimum 8 chars, at least 1 number and 1 special char
          const re = /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/;
          return re.test(password);
        }

        function calculatePasswordStrength(password) {
          let strength = 0;

          // Length
          if (password.length > 7) strength += 1;
          if (password.length > 11) strength += 1;

          // Contains numbers
          if (/\d/.test(password)) strength += 1;

          // Contains special chars
          if (/[!@#$%^&*]/.test(password)) strength += 1;

          // Contains both lower and upper case
          if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 1;

          return Math.min(strength, 5); // Max strength 5
        }

        function updatePasswordStrengthIndicator(strength) {
          const colors = [
            "#dc3545",
            "#fd7e14",
            "#ffc107",
            "#28a745",
            "#20c997",
          ];
          const width = (strength / 5) * 100;

          passwordStrengthBar.style.width = `${width}%`;
          passwordStrengthBar.style.backgroundColor =
            colors[strength - 1] || colors[0];
        }
      });
    </script>
  </body>
</html>